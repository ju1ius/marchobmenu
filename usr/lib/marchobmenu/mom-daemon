#! /bin/bash

set -u

################################################################################
#		VARIABLES
#-------------------------------------------------------------------------------
APP_PATH=$(readlink -f $0)
APP_DIR=$(dirname $APP_PATH)
APP_DAEMON=$(basename $APP_PATH)

PID=$$

# Needed if script was called with sudo
USER=$(whoami | sed 's/ .*//')
HOME=/home/$USER

WDIR="$HOME/.config/openbox/marchobmenu"
if [[ ! -d $WDIR ]]
then
  mkdir -p $WDIR
fi

LOGFILE="$WDIR/$APP_DAEMON.log"
PIDFILE="$WDIR/$APP_DAEMON.pid"

BUILD_CMD="$APP_DIR/mom.py"
CACHE_FILE="$WDIR/menu.cache"

PKG_NAME='marchobmenu'
TRIGGERS_DB="/var/lib/dpkg/triggers/File"

MONITORED=(
  # .directory files
  [0]="/usr/share/desktop-directories"
  [1]="/usr/local/share/desktop-directories"
  [2]="/home/*/.local/share/desktop-directories"
  # .desktop files
  [3]="/usr/share/applications"
  [4]="/usr/local/share/applications"
  [5]="/home/*/.local/share/applications"
  # LXDE Stuff
  [6]="/etc/xdg/menus/lxde-applications-merged"
  [7]="/home/*/.config/menus/lxde-applications-merged"
)
EXCLUDED=(
  [0]="/.local/share/applications/menu-xdg/"
)

#-------------------------------------------------------------------------------
#		/VARIABLES
################################################################################



################################################################################
#		FUNCTIONS
#-------------------------------------------------------------------------------
check_triggers()
{
  if grep $PKG_NAME $TRIGGERS_DB
  then
    cat << _ERROR
  Uh oh...
  It seems you have dpkg-triggers running for $PKG_NAME
  You must disable them before starting the daemon.
  Run:
  $ mom-daemon disable-triggers
  Or:
  $ mom-daemon help
  if you want to know more about dpkg-triggers
_ERROR
    exit 1
  fi
}
#################################################
# Public API
#------------------------------------------------
start()
{
  check_triggers
  stop
  update
  # Get watched directories for the current user
  WATCHED=$(for d in "${MONITORED[@]}"
  do
    tmp=$(echo "$d" | sed "s/*/$USER/" )
    if [[ -d $tmp ]]; then echo "$tmp"; fi;
  done)
  #
  EXCLUDES=$(for pattern in "${EXCLUDED[@]}"
  do
    echo "-e $pattern"
  done)
  #
  $APP_WATCH -d \
    -c "$BUILD_CMD > $CACHE_FILE" \
    $EXCLUDES \
    $WATCHED > $LOGFILE
}

stop()
{
  pkill -u "$USER" mom-watch
}

update()
{
  $BUILD_CMD > $CACHE_FILE
}

show()
{
  cat $CACHE_FILE
}

disable_triggers()
{
  if [[ -e $TRIGGERS_DB ]]
  then
    sudo sed -i -e "/$PKG_NAME$/d" $TRIGGERS_DB
  else
    echo "Your system doesn't support dpkg-triggers. Please use the daemon instead."
    exit 1
  fi
}

enable_triggers()
{
  if [[ -e $TRIGGERS_DB ]]
  then
    stop
    disable_triggers
    for d in "${MONITORED[@]}"
    do
      echo "$d $PKG_NAME" | sudo tee -a $TRIGGERS_DB
    done
  else
    echo "Your system doesn't support dpkg-triggers. Please use the daemon instead."
    exit 1
  fi
}

synopsis()
{
cat << _USAGE
mom-daemon - monitors installed applications to generate a an Openbox PipeMenu

Synopsis
--------
mom-daemon help             - Prints the help message and exits
mom-daemon start            - Starts the menu daemon
mom-daemon stop             - Stops the menu daemon
mom-daemon update           - Regenerates the menu
mom-daemon enable-triggers  - Add dpkg-triggers (see mom-daemon help for more infos)
mom-daemon disable-triggers - Remove dpkg-triggers (see mom-daemon help for more infos)
_USAGE
}

usage ()
{
  synopsis
cat << _USAGE
About dpkg-triggers:
--------------------
  dpkg-triggers are a Debian/Apt specific way to trigger actions
  when a new package is installed/removed.
  They allow MarchOBMenu to update the menu without the overhead
  of running a daemon.

  However, they only work with packages installed by apt or dpkg.
  This is why they are not enabled by default.

  If you wish to activate this feature, first stop the daemon:
  $ mom-daemon stop
  Then execute:
  $ mom-daemon enable-triggers

  From now on, if you install a program in a non-standard way,
  like compiling from source, or a wine application,
  you'll need to explicitly update the menu by executing:
  $ mom-daemon update

  You can deactivate this feature later it by executing:
  $ mom-daemon disable-triggers
_USAGE

}
#-------------------------------------------------------------------------------
#		/FUNCTIONS
################################################################################




################################################################################
#		MAIN
#-------------------------------------------------------------------------------
case "$1" in
  start|restart)
    start
  ;;
  stop)
    stop
  ;;
  update)
    update
  ;;
  show)
    show
  ;;
  disable-triggers)
    disable_triggers
  ;;
  enable-triggers)
    enable_triggers
  ;;
  help)
    usage
  ;;
  *)
    synopsis
  ;;
esac
#-------------------------------------------------------------------------------
#		/MAIN
################################################################################
